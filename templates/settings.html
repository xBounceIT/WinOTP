{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Header with back button -->
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-3">
            <img src="{{ url_for('static', filename='icons/back_arrow.png') }}" alt="Back" width="16" height="16">
        </a>
        <h2 class="mb-0">Settings</h2>
    </div>

    <!-- Settings Options -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Application Settings</h5>
                </div>
                <div class="card-body">
                    <!-- About Button -->
                    <div class="d-grid">
                        <a href="{{ url_for('about') }}" class="btn btn-outline-secondary text-start mb-3">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='icons/question.png') }}" alt="About" width="20" height="20" class="me-3">
                                <div>
                                    <span>About WinOTP</span>
                                    <small class="d-block text-muted">View application information and version</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Export/Backup Section -->
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0">Data Management</h5>
                </div>
                <div class="card-body">
                    <p class="text-warning mb-4">
                        <img src="{{ url_for('static', filename='icons/warning.png') }}" alt="Warning" width="16" height="16" class="me-2">
                        These actions affect your token data. Use with caution.
                    </p>
                    
                    <!-- Export Tokens Button -->
                    <div class="d-grid mb-3">
                        <button id="export-tokens-btn" class="btn btn-outline-primary text-start">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='icons/download.png') }}" alt="Export" width="20" height="20" class="me-3">
                                <div>
                                    <span>Export Tokens</span>
                                    <small class="d-block text-muted">Save your tokens to a JSON file for backup</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Reset All Button -->
                    <div class="d-grid">
                        <button id="reset-all-btn" class="btn btn-outline-danger text-start">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='icons/delete.png') }}" alt="Reset" width="20" height="20" class="me-3">
                                <div>
                                    <span>Reset All Tokens</span>
                                    <small class="d-block text-muted">Delete all tokens (cannot be undone)</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Handle export tokens button
        $('#export-tokens-btn').click(function() {
            // Get all tokens
            $.get("{{ url_for('get_tokens') }}", function(data) {
                // Create a formatted JSON object with just the token data
                const exportData = {};
                
                data.forEach(function(token) {
                    exportData[token.id] = {
                        issuer: token.issuer,
                        name: token.name,
                        secret: token.secret
                    };
                });
                
                // Convert to JSON string
                const jsonStr = JSON.stringify(exportData, null, 2);
                
                // Create a download link
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create a temporary link and click it
                const a = document.createElement('a');
                a.href = url;
                a.download = 'winotp_tokens_' + new Date().toISOString().slice(0, 10) + '.json';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            });
        });
        
        // Handle reset all button
        $('#reset-all-btn').click(function() {
            if (confirm('Are you sure you want to delete ALL tokens? This action cannot be undone.')) {
                if (confirm('FINAL WARNING: All tokens will be permanently deleted. Continue?')) {
                    // Get all tokens
                    $.get("{{ url_for('get_tokens') }}", function(data) {
                        let deleteCount = 0;
                        const totalTokens = data.length;
                        
                        // Delete each token
                        data.forEach(function(token) {
                            $.ajax({
                                url: "{{ url_for('delete_token', token_id='') }}" + token.id,
                                type: 'DELETE',
                                success: function() {
                                    deleteCount++;
                                    
                                    // If all tokens are deleted, reload the page
                                    if (deleteCount === totalTokens) {
                                        alert('All tokens have been deleted');
                                        window.location.href = "{{ url_for('index') }}";
                                    }
                                }
                            });
                        });
                        
                        // If no tokens to delete, just reload
                        if (totalTokens === 0) {
                            alert('No tokens to delete');
                            window.location.href = "{{ url_for('index') }}";
                        }
                    });
                }
            }
        });
    });
</script>
{% endblock %} 