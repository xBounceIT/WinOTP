<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinOTP</title>
    <link rel="icon" type="image/png" href="app.png">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <!-- Include all page components directly in the main HTML -->
    <!-- Main Page -->
    <div class="container" id="mainPage">
        <div class="header">
            <h1>WinOTP</h1>
            <div class="header-actions">
                <button id="updateAvailableBtn" class="btn btn-update-available" style="display: none;">UPDATE AVAILABLE</button>
                <button id="addTokenBtn" class="btn btn-icon"><img id="plusIcon" src="static/icons/plus.png" alt="Add Token" width="20" height="20"></button>
                <button id="toggleSortBtn" class="btn btn-icon" title="Toggle Sort Order"><img id="sortIcon" src="static/icons/sort_asc.png" alt="Sort Order" width="20" height="20"></button>
                <button id="settingsBtn" class="btn btn-icon"><img id="settingsIcon" src="static/icons/settings.png" alt="Settings" width="20" height="20"></button>
            </div>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search tokens...">
        </div>

        <div id="tokenList" class="token-list">
            <!-- Tokens will be added here dynamically -->
        </div>
    </div>

    <!-- Settings Page content moved to ui/pages/settings.html -->

    <!-- About Page -->
    <div class="container" id="aboutPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <button id="backFromAboutBtn" class="btn btn-icon"><img id="backFromAboutIcon" src="static/icons/back_arrow.png" alt="Back" width="20" height="20"></button>
                <h1>About</h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="about-section">
                <h2>WinOTP Authenticator</h2>
                <p>A modern, secure, and feature-rich TOTP authenticator designed specifically for Windows, offering a user-friendly interface and robust security features.</p>
                <p id="appVersion">Version: Loading...</p>
            </div>
            <div class="about-section">
                <h2>Features</h2>
                <ul>
                    <li>Generate TOTP codes for two-factor authentication</li>
                    <li>Scan QR codes to add tokens easily</li>
                    <li>Manual entry and management of token details</li>
                    <li>NTP time synchronization for accurate code generation</li>
                    <li>Multiple authentication options:
                        <ul>
                            <li>PIN protection</li>
                            <li>Password protection</li>
                        </ul>
                    </li>
                    <li>Token management features:
                        <ul>
                            <li>Import/Export tokens as JSON</li>
                            <li>Customizable token sorting</li>
                            <li>Token editing and deletion</li>
                        </ul>
                    </li>
                    <li>System integration:
                        <ul>
                            <li>Minimize to system tray option</li>
                            <li>Encrypted token storage</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Import Tokens Page -->
    <div class="container" id="importTokensPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <button id="backFromImportBtn" class="btn btn-icon"><img id="backFromImportIcon" src="static/icons/back_arrow.png" alt="Back" width="20" height="20"></button>
                <h1>Import Tokens</h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="import-section">
                <p>Select a source to import your authentication tokens from:</p>
                
                <div class="import-options">
                    <button id="importFromWinOTPBtn" class="btn btn-block">
                        <div class="import-option-content">
                            <span class="import-option-title">WinOTP Backup</span>
                            <span class="import-option-desc">Import from another WinOTP instance or backup file</span>
                        </div>
                    </button>
                    <button id="importFrom2FASBtn" class="btn btn-block">
                        <div class="import-option-content">
                            <span class="import-option-title">2FAS Backup</span>
                            <span class="import-option-desc">Import from a 2FAS backup file (.2fas)</span>
                        </div>
                    </button>
                    <button id="importFromAuthenticatorPluginBtn" class="btn btn-block">
                        <div class="import-option-content">
                            <span class="import-option-title">Authenticator Plugin</span>
                            <span class="import-option-desc">Import from Authenticator Browser Plugin export (.txt)</span>
                        </div>
                    </button>
                    <button id="importFromGoogleAuthBtn" class="btn btn-block">
                        <div class="import-option-content">
                            <span class="import-option-title">Google Authenticator</span>
                            <span class="import-option-desc">Import from Google Authenticator QR codes</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Progress Page -->
    <div class="container" id="importProgressPage" style="display: none;">
        <div class="header">
            <h1>Importing Tokens...</h1>
        </div>
        <div class="settings-content">
            <p id="importProgressStatus">Starting import...</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="importProgressBar" style="width: 0%;"></div>
            </div>
            <p id="importProgressCount">(0/0)</p>
            <p style="margin-top: 20px; font-size: 0.8em; color: var(--secondary-text-color);">Please wait, this may take a moment for large files.</p>
        </div>
    </div>

    <!-- Google Authenticator Import Page -->
    <div class="container" id="googleAuthImportPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <button id="backFromGoogleAuthBtn" class="btn btn-icon"><img id="backFromGoogleAuthIcon" src="static/icons/back_arrow.png" alt="Back" width="20" height="20"></button>
                <h1>Import from Google Authenticator</h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="import-section">
                <h2>Instructions</h2>
                <ol class="instructions-list">
                    <li>On your phone, open the Google Authenticator app</li>
                    <li>Tap the menu icon (three dots) in the top right</li>
                    <li>Tap on "Transfer accounts"</li>
                    <li>Tap on "Export accounts"</li>
                    <li>You may need to authenticate (fingerprint/face/PIN)</li>
                    <li>Select the accounts you want to export</li>
                    <li>Tap "Next"</li>
                    <li>Take a screenshot or photo of the QR code(s) shown</li>
                    <li>Upload the screenshots/photos below</li>
                </ol>
                
                <div class="info-box" style="margin: 15px 0;">
                    <p><strong>Note:</strong> Google Authenticator may disable screenshots. If so, use another device to take a photo of the QR code(s).</p>
                    <p>Multiple QR codes may appear if you have many accounts. Upload all of them to import all your tokens.</p>
                </div>
                
                <div class="qr-scanner-container">
                    <div id="qrScannerArea"></div>
                    <div class="scanner-controls">
                        <button id="finishGoogleAuthImportBtn" class="btn">Finish Import</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Token Page -->
    <div class="container" id="addTokenPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <button id="backFromAddTokenBtn" class="btn btn-icon"><img id="backFromAddTokenIcon" src="static/icons/back_arrow.png" alt="Back" width="20" height="20"></button>
                <h1>Add Token</h1>
            </div>
            <div class="header-actions">
                <!-- Actions can be added here if needed in the future -->
            </div>
        </div>
        
        <div class="settings-content">
            <div class="tabs">
                <div class="tab active" data-tab="scanQr">Scan QR</div>
                <div class="tab" data-tab="manualEntry">Manual Entry</div>
            </div>
            <div id="scanQr" class="tab-content active">
                <div class="info-box" id="cameraPermissionInfo" style="margin-bottom: 20px;">
                    <p>Click "Start Scanning" to open your camera and scan a QR code.</p>
                </div>
                <div class="form-actions">
                    <button class="btn" id="startScanBtn">Start Scanning</button>
                    <button class="btn" id="uploadQrBtn">Upload QR Image</button>
                    <input type="file" id="qrFileInput" accept="image/*" style="display: none;">
                </div>
            </div>
            <div id="manualEntry" class="tab-content">
                <div class="form-group">
                    <label for="tokenIssuer">Issuer (Service Name)</label>
                    <input type="text" id="tokenIssuer" placeholder="Google, Microsoft, etc.">
                </div>
                <div class="form-group">
                    <label for="tokenName">Account Name</label>
                    <input type="text" id="tokenName" placeholder="username@example.com">
                </div>
                <div class="form-group">
                    <label for="tokenSecret">Secret Key</label>
                    <input type="text" id="tokenSecret" placeholder="Base32 encoded secret">
                </div>
                <div class="form-actions">
                    <button class="btn" id="saveTokenBtn">Save Token</button>
                </div>
                
                <div class="form-separator">
                    <span>OR</span>
                </div>
                
                <div class="form-group">
                    <label for="tokenUri">OTP Auth URI</label>
                    <input type="text" id="tokenUri" placeholder="otpauth://totp/...">
                    <div class="input-description">Paste a complete otpauth:// URI. The secret must be a valid base32 string (A-Z, 2-7).</div>
                </div>
                <div class="form-actions">
                    <button class="btn" id="saveUriTokenBtn">Add from URI</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Protection Page -->
    <div class="container" id="appProtectionPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <button id="backFromProtectionBtn" class="btn btn-icon"><img id="backFromProtectionIcon" src="static/icons/back_arrow.png" alt="Back" width="20" height="20"></button>
                <h1>App Protection</h1>
            </div>
        </div>
        
        <div class="settings-content">
            <div class="protection-section">
                <p>Choose how you want to protect your app:</p>
                
                <div id="protectionStatus" class="setting-item" style="margin-bottom: 20px;">
                    <div>
                        <div class="setting-label">Current Status</div>
                        <div id="protectionStatusText" class="protection-status-badge"></div>
                    </div>
                </div>
                
                <div class="info-box">
                    <p>When you enable protection, your tokens will be automatically encrypted using your PIN/password. This ensures that only you can access your tokens when the app is locked.</p>
                </div>
                
                <div class="protection-options">
                    <div id="protectionForms" style="display: none;">
                        <div class="form-group">
                            <label for="pinInput">PIN Protection</label>
                            <input type="password" id="pinInput" placeholder="Enter a PIN (at least 4 digits)" inputmode="numeric" pattern="[0-9]*">
                            <div class="input-description">PIN must be at least 4 digits</div>
                            <div class="form-actions" style="margin-top: 10px;">
                                <button class="btn" id="setPinBtn">Set PIN</button>
                            </div>
                        </div>
                        
                        <div class="form-separator">
                            <span>OR</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="passwordInput">Password Protection</label>
                            <input type="password" id="passwordInput" placeholder="Enter a password (at least 6 characters)">
                            <div class="input-description">Password must be at least 6 characters</div>
                            <div class="form-actions" style="margin-top: 10px;">
                                <button class="btn" id="setPasswordBtn">Set Password</button>
                            </div>
                        </div>
                    </div>

                    <div id="disableProtectionSection" style="margin-top: 30px; display: none;">
                        <div class="form-separator">
                            <span>OR</span>
                        </div>
                        
                        <div class="form-actions" style="margin-top: 20px;">
                            <button class="btn btn-danger" id="disableProtectionBtn">Disable Protection</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="container" id="loginPage" style="display: none;">
        <div class="header">
            <div class="header-left">
                <h1>WinOTP Authenticator</h1>
            </div>
        </div>
        
        <div class="login-content">
            <div class="login-section">
                <h2 id="loginTitle">Enter PIN</h2>
                <p id="loginDescription">Please enter your PIN to access the app</p>
                
                <div class="form-group">
                    <input type="password" id="loginCredential" placeholder="Enter your PIN" autofocus>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                </div>
                
                <div class="form-actions">
                    <button class="btn" id="loginBtn">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- End of existing pages -->
    
    <!-- Load pages from html files -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // List of page files to load
            const pageFiles = [
                'pages/add-token.html',
                'pages/app-protection.html',
                'pages/import-tokens.html',
                'pages/google-auth-import.html',
                'pages/import-progress.html',
                'pages/login.html',
                'pages/update.html',  // Add the update page to the list
                'pages/settings.html'  // Add the settings page to the list
            ];
            
            // Function to load HTML content
            async function loadPageContent(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${url}: ${response.status} ${response.statusText}`);
                    }
                    return await response.text();
                } catch (error) {
                    console.error(`Error loading page content from ${url}:`, error);
                    return '';
                }
            }
            
            // Load all page files and append to body
            for (const file of pageFiles) {
                const content = await loadPageContent(file);
                if (content) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    document.body.appendChild(tempDiv.firstElementChild);
                }
            }
            
            // Fire an event to signal all pages are loaded
            document.dispatchEvent(new CustomEvent('allPagesLoaded'));
        });
    </script>
    
    <!-- JavaScript dependencies -->
    <script src="static/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/jquery-3.6.0.min.js"></script>
    
    <!-- Application JavaScript modules -->
    <script src="static/js/utils.js"></script>
    <script src="static/js/icons.js"></script>
    <script src="static/js/ui.js"></script>
    <script src="static/js/auth.js"></script>
    <script src="static/js/tokens.js"></script>
    <script src="static/js/import-export.js"></script>
    <script src="static/js/core.js"></script>
</body>
</html>